{% extends "base.html" %}
{% block title %} fixcity.org {% endblock %}

{% block extra_header %}

<script type="text/javascript" src="/site_media/openlayers/OpenLayers.js"></script>
<script defer="defer" type="text/javascript">
    var map, layer, select;
    var options = {
            projection: new OpenLayers.Projection("EPSG:900913"),
	    displayProjection: new OpenLayers.Projection("EPSG:4326"),
	    units: "m",
	    numZoomLevels:19,
            maxResolution: 156543.03390625,
	    maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
					     20037508.34, 20037508.34)
	   };

        function loadMap(){
	map = new OpenLayers.Map('home-map',options);

	var osm = new OpenLayers.Layer.WMS(
                 "OpenStreetMap",
                 "http://maps.opengeo.org/geowebcache/service/wms",
       {
            layers: "openstreetmap",
            format: "image/png",
            bgcolor: '#A1BDC4'
            },
            {wrapDateLine: true}
        );

	var style = new OpenLayers.Style({
      		    label: "${count}",
                    fillColor: "#ff9e73",
                    strokeColor: "#80503b",
                    pointRadius: "10",
                    strokeWidth: 2,
                    strokeOpacity: 0.8

                }, {
                    context: {
                        radius: function(feature) {
                            return Math.min(feature.attributes.count, 10) + 10;
		    },
			count: function(feature) {
			return feature.attributes.id ;
		    }

                    }
                });


	var style_built = new OpenLayers.Style({
                    pointRadius: "${radius}",
                    fillColor: "#ff9e73",
                    strokeColor: "#80503b",
                    strokeWidth: 2,
                    strokeOpacity: 0.8

                }, {
                    context: {
                        radius: function(feature) {
                            return Math.min(feature.attributes.count, 7) + 3;
                        }
                    }
                });


	var racks = new OpenLayers.Layer.Vector("Racks", {
		    projection: map.displayProjection,
		    extractFeatures: true,
                    strategies: [
			new OpenLayers.Strategy.Fixed(),
                    ],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: "./rack/requested.kml",
                        params: {
                        },
                        format: new OpenLayers.Format.KML()
                    }),
                    styleMap: new OpenLayers.StyleMap({
                        "default": style,
                        "select": {
                            fillColor: "#ff9e73",
                            strokeColor: "#925438"
                        }
                    })

                });


	var racks_built = new OpenLayers.Layer.Vector("Racks", {
		    projection: map.displayProjection,
                    strategies: [
                        new OpenLayers.Strategy.Fixed(),
                    ],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: "./rack/built.kml",
                        params: {

                        },
                        format: new OpenLayers.Format.KML()
                    }),
                    styleMap: new OpenLayers.StyleMap({
                        "default": style_built,
                        "select": {
                            fillColor: "#8aeeef",
                            strokeColor: "#32a8a9"
                        }
                    })

                });


        map.addLayers([osm,racks]);

        selectControl = new OpenLayers.Control.SelectFeature(
           [racks],
          {
	      clickout:true, toggle: false,
	      multiple: false, hover: false
          });

	map.addControl(selectControl);
	selectControl.activate();

	racks.events.on({
		"featureselected": function(e) {
                    content = "<div><h3> <a href='/rack/" + e.feature.attributes.id + "'>" + e.feature.attributes.name +"</a> </h3> <p> " +  e.feature.attributes.description  +" </div>",
		    popup = new OpenLayers.Popup.FramedCloud("chicken",
				 e.feature.geometry.getBounds().getCenterLonLat(),
				 null,
				 content,
				 null, true );
		               e.feature.popup = popup;
               		    map.addPopup(popup);
		},
		  "featureunselected": function(e) {
		      map.removePopup(e.feature.popup);
		      e.feature.popup.destroy();
		      e.feature.popup = null;
		 }


	    });


        var bounds = new OpenLayers.Bounds(-73.9703369140625, 40.698036193847699, -73.920738220214801, 40.739128112792997) ;
        bounds.transform(map.displayProjection, map.projection);
        map.zoomToExtent(bounds);
        }


</script>

<script defer="defer" type="text/javascript">
  window.onload = function() {
    loadMap() ;
   }
</script>

{% endblock %}
{% block menu %}
<ul id="menu">
  <li class="active suggest">
    <a href="/">(1) SUGGEST</a>
    <p> Suggest a bike rack location</p>
  </li>
  <li class="assess">
    <a href="/assess/">(2) ASSESS</a>
    <p> Assess current requested locations </p>
  </li>
  <li class="about">
     <a href="/about/">About</a>
     <p> Find out more information</p>
  </li>
</ul>
{% endblock %}


{% block content %}
<form id="addrack-form" action="#" method="get">
	<label for="location">Business, Agency, or Public Space</label>
	<div class="required"><input id="location" name="location" type="text" title="Assume we want placeholder text here" value="" /></div>
	<label for="address">Street Address</label>
	<div class="required"><input id="address" name="address" type="text" title="Enter an address or click a point on the map" /></div>
	<label for="description">Description</label>
	<textarea id="description" name="description" title="Please include any useful details and available contact information for property/business owner"></textarea>
	<div class="checkboxes selfclear"><span><input id="restaurant" name="restaurant" type="checkbox" /><label for="restaurant">Restaurant</label></span><span><input id="school" name="school" type="checkbox" /><label for="school">School</label></span></div>
  <input id="browse" name="browse" type="file">
  <div id="fakebrowse" class="selfclear"><input name="fakebrowseinput" id="fakebrowseinput" type="text" /><span class="fakebutton">browse</span></div>
	<input type="submit" value="Add this rack!" />
</form>
<div class="suggest">
	<div id="home-map">
	</div><!-- /#home-map -->
</div><!-- /#suggest -->
{% endblock %}

{% block lede %}
<h1>Report Damaged Rack</h1><a href="#">Suggest a new Rack</a>
{% endblock %}

{% block extra_footer %}
<script type="text/javascript">
//<![CDATA[
  $(document).ready(function() {
    $('input#location, input#address, textarea#description').inlineInfoTextify();
    $('input#browse').change(function( objEvent ){$('#fakebrowseinput').val($(this).val());});
    $('.checkboxes input').click(function(){(this.checked) ? $(this).parent().addClass('checked') : $(this).parent().removeClass('checked');});
  });
//]]>
</script>
{% endblock %}

