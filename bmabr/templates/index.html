{% extends "base.html" %}
{% block title %} fixcity.org {% endblock %}

{% block header %}

<script type="text/javascript" src="/site_media/openlayers/OpenLayers.js"></script>
<script defer="defer" type="text/javascript">
    var map, layer, select;
    var options = {
            projection: new OpenLayers.Projection("EPSG:900913"),
	    displayProjection: new OpenLayers.Projection("EPSG:4326"),
	    units: "m",
	    numZoomLevels:19,
            maxResolution: 156543.03390625,
	    maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
					     20037508.34, 20037508.34)
	   };

        function loadMap(){
	map = new OpenLayers.Map('home-map',options);

	var osm = new OpenLayers.Layer.WMS(
                 "OpenStreetMap",
                 "http://maps.opengeo.org/geowebcache/service/wms",
       {
            layers: "openstreetmap",
            format: "image/png",
            bgcolor: '#A1BDC4'
            },
            {wrapDateLine: true}
        );

	var style = new OpenLayers.Style({
      		    label: "${count}",
		    fontColor: "#eee",
                    pointRadius: "10",
		    fillColor: "#30c09b",
                    strokeColor: "#1e7861",
                    strokeWidth: 2,
                    strokeOpacity: 0.8

                }, {
                    context: {
                        radius: function(feature) {
                            return Math.min(feature.attributes.count, 10) + 10;
		    },
			count: function(feature) {
			return feature.attributes.id ;
		    }

                    }
                });


	var style_built = new OpenLayers.Style({
                    pointRadius: "${radius}",
		    fillColor: "#9a97d4",
                    strokeColor: "#3c34b4",
                    strokeWidth: 2,
                    strokeOpacity: 0.8

                }, {
                    context: {
                        radius: function(feature) {
                            return Math.min(feature.attributes.count, 7) + 3;
                        }
                    }
                });


	var racks = new OpenLayers.Layer.Vector("Racks", {
		    projection: map.displayProjection,
		    extractFeatures: true,
                    strategies: [
			new OpenLayers.Strategy.Fixed(),
                    ],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: "./rack/requested.kml",
                        params: {
                        },
                        format: new OpenLayers.Format.KML()
                    }),
                    styleMap: new OpenLayers.StyleMap({
                        "default": style,
                        "select": {
                            fillColor: "#ff9e73",
                            strokeColor: "#925438"
                        }
                    })

                });


	var racks_built = new OpenLayers.Layer.Vector("Racks", {
		    projection: map.displayProjection,
                    strategies: [
                        new OpenLayers.Strategy.Fixed(),
                    ],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: "./rack/built.kml",
                        params: {

                        },
                        format: new OpenLayers.Format.KML()
                    }),
                    styleMap: new OpenLayers.StyleMap({
                        "default": style_built,
                        "select": {
                            fillColor: "#8aeeef",
                            strokeColor: "#32a8a9"
                        }
                    })

                });


        map.addLayers([osm,racks]);

        selectControl = new OpenLayers.Control.SelectFeature(
           [racks],
          {
	      clickout:true, toggle: false,
	      multiple: false, hover: false
          });

	map.addControl(selectControl);
	selectControl.activate();

	racks.events.on({
		"featureselected": function(e) {
                    content = "<div><h3> <a href='/rack/" + e.feature.attributes.id + "'>" + e.feature.attributes.name +"</a> </h3> <p> " +  e.feature.attributes.description  +" </div>",
		    popup = new OpenLayers.Popup.FramedCloud("chicken",
				 e.feature.geometry.getBounds().getCenterLonLat(),
				 null,
				 content,
				 null, true );
		               e.feature.popup = popup;
               		    map.addPopup(popup);
		},
		  "featureunselected": function(e) {
		      map.removePopup(e.feature.popup);
		      e.feature.popup.destroy();
		      e.feature.popup = null;
		 }


	    });


        var bounds = new OpenLayers.Bounds(-73.9703369140625, 40.698036193847699, -73.920738220214801, 40.739128112792997) ;
        bounds.transform(map.displayProjection, map.projection);
        map.zoomToExtent(bounds);
        }


</script>

<script defer="defer" type="text/javascript">
  window.onload = function() {
    loadMap() ;
   }
</script>

{% endblock %}
{% block menu %}
<ul id="menu">
  <li class="active suggest">
    <a href="/">(1) SUGGEST</a>
    <p> Suggest a bike rack location</p>
  </li>
  <li class="assess">
    <a href="/assess/">(2) ASSESS</a>
    <p> Assess current requested locations </p>
  </li>
  <li class="submit">
    <a href="/submit/">(3) SUBMIT</a>
    <p> Submit your request to the DOT </p>
  </li>
  <li class="built">
    <a href="/built/"> (4) BUILD</a>
    <p> See racks aready built </p>
  </li>
</ul>
{% endblock %}


{% block content %}
<div class="suggest">
  <br />
    <div id="home-map"> </div>
    <div id="introduction-text">
  <div id="index-form">
    <h2>Collaborate with your community and the DOT to get better bike parking faster!</h2>
    <form action="rack/new/" method="GET">
      <button>Suggest a rack location </button>
    </form>
    <h4>Read this success story from the <a href="http://www.livablestreets.com/streetswiki/request-bike-racks-for-your-neighborhood"> Park Slope Civic Council</a></h4>
  </div>
  <br />
  </div>
</div>
{% endblock %}



